// Module included in the following assemblies:
//
// * scalability_and_performance/optimizing-cpu-usage.adoc

[id="enabling-encapsulation_{context}"]
= Configuring mount namespace encapsulation

You can configure mount namespace encapsulation so that the cluster runs with less resources overhead.

.Prerequisites

* You have installed the OpenShift CLI (`oc`).

* You have logged in as a user with `cluster-admin` privileges.

.Procedure

. Create `MachineConfig` resources that configure mount namespace encapsulation for `systemd` processes for control-plane and worker nodes. For example:

.. Save the following YAML in the `mount_namespace_config.yaml` file:
+
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-kubens-master
spec:
  config:
    ignition:
      version: 3.2.0
    systemd:
      units:
      - enabled: true <1>
        name: kubens.service
---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: 99-kubens-worker
spec:
  config:
    ignition:
      version: 3.2.0
    systemd:
      units:
      - enabled: true <2>
        name: kubens.service
----
<1> Set `enabled` to true to configure encapsulation for the control-plane nodes.
<2> Set `enabled` to true to configure encapsulation for worker nodes.

. Create the mount namespace `MachineConfig` CR:
+
[source,terminal]
----
$ oc create -f mount_namespace_config.yaml
----

.Verification

Check that mount namespace encapsulation is enabled for the cluster node.

. Open a debug shell to the node, for example:
+
[source,terminal]
----
$ oc debug node/control-plane-1.example.com
----

. Check that the mount namespaces associated with the container runtime, Kubelet, and CRI-O are correctly encapsulated, for example:

.. Get the Kubelet mount namespace by running the following command:
+
[source,terminal]
----
sh-4.4# readlink /proc/$(pgrep kubelet)/ns/mnt
----
+
.Example output
[source,terminal]
----
mnt:[4026532319]
----

.. Get the CRI-O mount namespace:
+
[source,terminal]
----
sh-4.4# readlink /proc/$(pgrep crio)/ns/mnt
----
+
.Example output
[source,terminal]
----
mnt:[4026532319]
----

.. Get the container runtime namespace:
+
[source,terminal]
----
$ sh-4.4# readlink /proc/1/ns/mnt
----
+
.Example output
[source,terminal]
----
mnt:[4026531840] <1>
----
<1> the `/proc/1` container runtime is running at a different mount point to `kubelet` and `crio` processes, this means that namespace encapsulation has been applied successfully.
+
If all three processes are running at the same mount point, namespace encapsulation is not applied. You can troubleshoot and inspect mountpoints further using `nsenter` to execute and debug container namespace issues by running containers in different namespaces.
